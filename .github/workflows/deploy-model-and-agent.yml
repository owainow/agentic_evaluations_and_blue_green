name: Deploy Model and Create Agent with Azure Functions Tools

# Prerequisites:
# 1. Infrastructure must be deployed first (Function App with tools)
# 2. Service principal with Contributor role (for resource deployment)
# 3. Service principal with "Azure AI Developer" role (for agent creation)
# See docs/GITHUB_ACTIONS_SETUP.md for complete setup instructions

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
        default: 'dev'
      
      model_name:
        description: 'Model to deploy'
        required: true
        type: choice
        options:
          - gpt-4o
          - gpt-4o-mini
          - gpt-4
          - gpt-4-turbo
          - gpt-35-turbo
          - gpt-35-turbo-16k
        default: 'gpt-4o'
      
      model_version:
        description: 'Model version'
        required: true
        type: string
        default: '2024-11-20'
      
      deployment_name:
        description: 'Name for the model deployment (leave empty to auto-generate)'
        required: false
        type: string
      
      sku_name:
        description: 'Deployment SKU type'
        required: true
        type: choice
        options:
          - Standard
          - GlobalStandard
          - DataZoneStandard
        default: 'Standard'
      
      capacity:
        description: 'Deployment capacity (TPM in thousands)'
        required: true
        type: number
        default: 100
      
      agent_name:
        description: 'Name for the agent'
        required: true
        type: string
        default: 'test-agent'
      
      agent_instructions:
        description: 'Instructions for the agent'
        required: true
        type: string
        default: 'You are an agent that provides responses in JSON only. You are to follow a standard JSON request format with a "response" field containing the answer.'
      
      run_evaluation:
        description: 'Run evaluation after agent creation'
        required: false
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: '269eee56-58bc-45eb-9dca-4d22421c45fa'
  RESOURCE_GROUP: 'rg-aifoundry-dev'
  LOCATION: 'eastus'

jobs:
  deploy-model-and-agent:
    name: Deploy Model and Create Agent
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      
      - name: Generate deployment name
        id: deployment_name
        shell: bash
        run: |
          if [ -n "${{ inputs.deployment_name }}" ]; then
            DEPLOYMENT_NAME="${{ inputs.deployment_name }}"
          else
            # Auto-generate deployment name: model-environment-timestamp
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            DEPLOYMENT_NAME="${{ inputs.model_name }}-${{ inputs.environment }}-${TIMESTAMP}"
          fi
          echo "deployment_name=${DEPLOYMENT_NAME}" >> $GITHUB_OUTPUT
          echo "Generated deployment name: ${DEPLOYMENT_NAME}"
      
      - name: Get AI Services name
        id: ai_services
        shell: bash
        run: |
          # Get the AI Services account name from the existing deployment
          AI_SERVICES_NAME=$(az cognitiveservices account list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?kind=='AIServices'].name | [0]" \
            -o tsv)
          
          if [ -z "$AI_SERVICES_NAME" ]; then
            echo "Error: No AI Services account found in resource group"
            exit 1
          fi
          
          echo "ai_services_name=${AI_SERVICES_NAME}" >> $GITHUB_OUTPUT
          echo "Found AI Services account: ${AI_SERVICES_NAME}"
      
      - name: Deploy Model
        id: deploy_model
        shell: bash
        run: |
          echo "Deploying ${{ inputs.model_name }} (version ${{ inputs.model_version }})..."
          
          # Deploy using BICEP template
          DEPLOYMENT_OUTPUT=$(az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infrastructure/model-deployment.bicep \
            --parameters \
              aiServicesName="${{ steps.ai_services.outputs.ai_services_name }}" \
              deploymentName="${{ steps.deployment_name.outputs.deployment_name }}" \
              modelName="${{ inputs.model_name }}" \
              modelVersion="${{ inputs.model_version }}" \
              skuName="${{ inputs.sku_name }}" \
              capacity=${{ inputs.capacity }} \
            --query 'properties.outputs' \
            -o json)
          
          echo "Deployment completed!"
          echo "$DEPLOYMENT_OUTPUT" | jq '.'
          
          # Extract outputs
          ENDPOINT=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.endpoint.value')
          DEPLOYMENT_ID=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.deploymentId.value')
          
          echo "endpoint=${ENDPOINT}" >> $GITHUB_OUTPUT
          echo "deployment_id=${DEPLOYMENT_ID}" >> $GITHUB_OUTPUT
      
      - name: Verify Model Deployment
        shell: bash
        run: |
          echo "Verifying model deployment..."
          
          DEPLOYMENT_STATUS=$(az cognitiveservices account deployment show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ steps.ai_services.outputs.ai_services_name }} \
            --deployment-name ${{ steps.deployment_name.outputs.deployment_name }} \
            --query '{Name:name, Model:properties.model.name, Version:properties.model.version, State:properties.provisioningState, Capacity:sku.capacity}' \
            -o table)
          
          echo "$DEPLOYMENT_STATUS"
      
      - name: Get AI Foundry Project Details
        id: project_details
        shell: bash
        run: |
          # Query for AI Foundry (new architecture using CognitiveServices)
          echo "Searching for AI Foundry in resource group: ${{ env.RESOURCE_GROUP }}"
          
          # Get the AI Foundry resource (kind=AIServices)
          # First, get all AIServices accounts
          AI_FOUNDRY_DATA=$(az cognitiveservices account list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?kind=='AIServices'] | [0]" \
            -o json)
          
          if [ "$AI_FOUNDRY_DATA" == "null" ] || [ -z "$AI_FOUNDRY_DATA" ]; then
            echo "Error: No AI Foundry resource found in resource group ${{ env.RESOURCE_GROUP }}"
            echo "Available AI Services accounts:"
            az cognitiveservices account list --resource-group ${{ env.RESOURCE_GROUP }} --query "[].{Name:name, Kind:kind}" -o table
            exit 1
          fi
          
          AI_FOUNDRY_NAME=$(echo "$AI_FOUNDRY_DATA" | jq -r '.name')
          AI_FOUNDRY_ENDPOINT=$(echo "$AI_FOUNDRY_DATA" | jq -r '.properties.endpoint')
          
          echo "✅ Found AI Foundry: ${AI_FOUNDRY_NAME}"
          echo "   Endpoint: ${AI_FOUNDRY_ENDPOINT}"
          
          # Get the AI Foundry Project (child resource)
          # List all projects under this AI Foundry resource
          PROJECTS=$(az resource list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --resource-type "Microsoft.CognitiveServices/accounts/projects" \
            --query "[?starts_with(id, '/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.CognitiveServices/accounts/${AI_FOUNDRY_NAME}/')]" \
            -o json)
          
          if [ "$PROJECTS" == "[]" ] || [ -z "$PROJECTS" ]; then
            echo "Error: No projects found under AI Foundry resource ${AI_FOUNDRY_NAME}"
            exit 1
          fi
          
          # Get the first project name (format: "parent/projectName", we need just "projectName")
          PROJECT_FULL_NAME=$(echo "$PROJECTS" | jq -r '.[0].name')
          # Extract just the project name after the slash
          PROJECT_NAME=$(echo "$PROJECT_FULL_NAME" | sed 's|.*/||')
          
          if [ -z "$PROJECT_NAME" ] || [ "$PROJECT_NAME" == "null" ]; then
            echo "Error: Could not extract project name from: ${PROJECT_FULL_NAME}"
            exit 1
          fi
          
          # Construct the Agent Service endpoint
          # Format: https://{ai-foundry-name}.services.ai.azure.com/api/projects/{project-name}
          PROJECT_ENDPOINT="https://${AI_FOUNDRY_NAME}.services.ai.azure.com/api/projects/${PROJECT_NAME}"
          
          echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          echo "project_endpoint=${PROJECT_ENDPOINT}" >> $GITHUB_OUTPUT
          echo "ai_foundry_name=${AI_FOUNDRY_NAME}" >> $GITHUB_OUTPUT
          
          echo "✅ Found AI Foundry Project: ${PROJECT_NAME}"
          echo "   Agent Service Endpoint: ${PROJECT_ENDPOINT}"
      
      - name: Get Function App Details
        id: function_app
        shell: bash
        run: |
          # Get Function App details from infrastructure deployment
          echo "Getting Function App details from resource group: ${{ env.RESOURCE_GROUP }}"
          
          FUNCTION_APP_DATA=$(az functionapp list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[0]" \
            -o json)
          
          if [ "$FUNCTION_APP_DATA" == "null" ] || [ -z "$FUNCTION_APP_DATA" ]; then
            echo "Error: No Function App found in resource group ${{ env.RESOURCE_GROUP }}"
            echo "Please ensure infrastructure has been deployed first"
            exit 1
          fi
          
          FUNCTION_APP_NAME=$(echo "$FUNCTION_APP_DATA" | jq -r '.name')
          FUNCTION_APP_URL="https://$(echo "$FUNCTION_APP_DATA" | jq -r '.defaultHostName')"
          
          echo "function_app_name=${FUNCTION_APP_NAME}" >> $GITHUB_OUTPUT
          echo "function_app_url=${FUNCTION_APP_URL}" >> $GITHUB_OUTPUT
          
          echo "✅ Found Function App: ${FUNCTION_APP_NAME}"
          echo "   Function App URL: ${FUNCTION_APP_URL}"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install azure-ai-projects azure-identity requests
      
      - name: Create AI Agent with Azure Functions Tools
        id: create_agent
        continue-on-error: true
        shell: bash
        env:
          PROJECT_ENDPOINT: ${{ steps.project_details.outputs.project_endpoint }}
          MODEL_DEPLOYMENT_NAME: ${{ steps.deployment_name.outputs.deployment_name }}
          AGENT_NAME: ${{ inputs.agent_name }}
          AGENT_INSTRUCTIONS: ${{ inputs.agent_instructions }}
          FUNCTION_APP_URL: ${{ steps.function_app.outputs.function_app_url }}
        run: |
          echo "Creating agent with Azure Functions tools..."
          echo "Model deployment: ${MODEL_DEPLOYMENT_NAME}"
          echo "Function App URL: ${FUNCTION_APP_URL}"
          python scripts/create_agent_azure_functions.py
      
      - name: Agent Creation Status
        shell: bash
        run: |
          if [ "${{ steps.create_agent.outcome }}" == "failure" ]; then
            echo "⚠️ Agent creation failed."
            echo ""
            echo "Common causes:"
            echo "1. Missing 'Azure AI Developer' role on the service principal"
            echo "2. Role assignment not yet propagated (can take 5-10 minutes)"
            echo "3. Invalid PROJECT_ENDPOINT format"
            echo ""
            echo "To fix:"
            echo "1. Go to Azure Portal → AI Services resource → Access control (IAM)"
            echo "2. Add role assignment: 'Azure AI Developer'"
            echo "3. Assign to: github-actions-aifoundry (service principal)"
            echo ""
            echo "For detailed instructions, see: docs/GITHUB_ACTIONS_SETUP.md"
            echo ""
            echo "✅ The model deployment was successful and can be used directly."
          else
            echo "agent_created=true" >> $GITHUB_OUTPUT
            echo "✅ Agent created successfully!"
            echo "Agent ID: ${{ steps.create_agent.outputs.agentId }}"
            echo "Agent will be visible in Azure AI Foundry Studio: https://ai.azure.com"
          fi
      
      - name: Create Deployment Summary
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # 🤖 Model Deployment & Agent Creation Summary
          
          ## Deployment Details
          
          | Property | Value |
          |----------|-------|
          | **Environment** | ${{ inputs.environment }} |
          | **Model** | ${{ inputs.model_name }} |
          | **Version** | ${{ inputs.model_version }} |
          | **Deployment Name** | ${{ steps.deployment_name.outputs.deployment_name }} |
          | **SKU** | ${{ inputs.sku_name }} |
          | **Capacity** | ${{ inputs.capacity }} TPM (thousands) |
          | **AI Services** | ${{ steps.ai_services.outputs.ai_services_name }} |
          
          ## Agent Details
          
          EOF
          
          if [ "${{ steps.create_agent.outcome }}" == "success" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          | Property | Value |
          |----------|-------|
          | **Status** | ✅ Created Successfully |
          | **Agent Name** | ${{ inputs.agent_name }} |
          | **Agent ID** | ${{ steps.create_agent.outputs.agentId }} |
          | **Model Deployment** | ${{ steps.deployment_name.outputs.deployment_name }} |
          | **Project Endpoint** | ${{ steps.project_details.outputs.project_endpoint }} |
          
          ## Azure Functions Tools
          
          | Property | Value |
          |----------|-------|
          | **Function App** | ${{ steps.function_app.outputs.function_app_name }} |
          | **Function App URL** | ${{ steps.function_app.outputs.function_app_url }} |
          | **Weather Function** | ${{ steps.function_app.outputs.function_app_url }}/api/get_weather |
          | **News Function** | ${{ steps.function_app.outputs.function_app_url }}/api/get_news_articles |
          | **Portal** | [View in Azure AI Foundry Studio](https://ai.azure.com) |
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          | Property | Value |
          |----------|-------|
          | **Status** | ⚠️ Creation Failed |
          | **Agent Name** | ${{ inputs.agent_name }} (not created) |
          
          > **Note**: Check the logs above for error details.
          > The model deployment is complete and can be used directly.
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## Next Steps
          
          EOF
          
          if [ "${{ inputs.run_evaluation }}" == "true" ] && [ "${{ steps.create_agent.outcome }}" == "success" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          1. **Evaluation will run automatically** in the next job
          2. **Test the agent** in Azure AI Foundry Studio: [https://ai.azure.com](https://ai.azure.com)
             - Navigate to your project
             - Click "My agents" in the left menu
             - Find your agent: ${{ inputs.agent_name }}
          3. **Use the agent** via Azure AI Projects SDK (see examples in docs)
          4. **Monitor usage** in the AI Services resource
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          1. **Test the agent** in Azure AI Foundry Studio: [https://ai.azure.com](https://ai.azure.com)
             - Navigate to your project
             - Click "My agents" in the left menu
             - Find your agent: ${{ inputs.agent_name }}
          2. **Use the agent** via Azure AI Projects SDK (see examples in docs)
          3. **Monitor usage** in the AI Services resource
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## Useful Commands
          
          \`\`\`bash
          # List all deployments
          az cognitiveservices account deployment list \\
            --resource-group ${{ env.RESOURCE_GROUP }} \\
            --name ${{ steps.ai_services.outputs.ai_services_name }}
          
          # Delete this deployment
          az cognitiveservices account deployment delete \\
            --resource-group ${{ env.RESOURCE_GROUP }} \\
            --name ${{ steps.ai_services.outputs.ai_services_name }} \\
            --deployment-name ${{ steps.deployment_name.outputs.deployment_name }}
          \`\`\`
          EOF
    
    outputs:
      deployment_name: ${{ steps.deployment_name.outputs.deployment_name }}
      agent_id: ${{ steps.create_agent.outputs.agentId }}
      agent_name: ${{ steps.create_agent.outputs.agentName }}
      project_endpoint: ${{ steps.project_details.outputs.project_endpoint }}
      project_name: ${{ steps.project_details.outputs.project_name }}
      function_app_name: ${{ steps.function_app.outputs.function_app_name }}
      function_app_url: ${{ steps.function_app.outputs.function_app_url }}

  run-evaluation:
    name: Run Agent Evaluation
    needs: deploy-model-and-agent
    if: ${{ inputs.run_evaluation == true && needs.deploy-model-and-agent.outputs.agent_id != '' }}
    uses: ./.github/workflows/main.yml
    with:
      project_endpoint: ${{ needs.deploy-model-and-agent.outputs.project_endpoint }}
      deployment_name: ${{ needs.deploy-model-and-agent.outputs.deployment_name }}
      agent_id: ${{ needs.deploy-model-and-agent.outputs.agent_id }}
      data_file: 'weather_test.json'
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
