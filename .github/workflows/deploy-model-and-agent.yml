name: Deploy Model and Create Agent

# Prerequisites:
# 1. Service principal with Contributor role (for resource deployment)
# 2. Service principal with "Azure AI Developer" role (for agent creation)
# See docs/GITHUB_ACTIONS_SETUP.md for complete setup instructions

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
        default: 'dev'
      
      model_name:
        description: 'Model to deploy'
        required: true
        type: choice
        options:
          - gpt-4o
          - gpt-4o-mini
          - gpt-4
          - gpt-4-turbo
          - gpt-35-turbo
          - gpt-35-turbo-16k
        default: 'gpt-4o'
      
      model_version:
        description: 'Model version'
        required: true
        type: string
        default: '2024-11-20'
      
      deployment_name:
        description: 'Name for the model deployment (leave empty to auto-generate)'
        required: false
        type: string
      
      sku_name:
        description: 'Deployment SKU type'
        required: true
        type: choice
        options:
          - Standard
          - GlobalStandard
          - DataZoneStandard
        default: 'Standard'
      
      capacity:
        description: 'Deployment capacity (TPM in thousands)'
        required: true
        type: number
        default: 10
      
      agent_name:
        description: 'Name for the agent'
        required: true
        type: string
        default: 'test-agent'
      
      agent_instructions:
        description: 'Instructions for the agent'
        required: true
        type: string
        default: 'You are a helpful AI assistant that provides accurate and concise answers.'

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: '269eee56-58bc-45eb-9dca-4d22421c45fa'
  RESOURCE_GROUP: 'rg-aifoundry-dev'
  LOCATION: 'eastus'

jobs:
  deploy-model-and-agent:
    name: Deploy Model and Create Agent
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      
      - name: Generate deployment name
        id: deployment_name
        shell: bash
        run: |
          if [ -n "${{ inputs.deployment_name }}" ]; then
            DEPLOYMENT_NAME="${{ inputs.deployment_name }}"
          else
            # Auto-generate deployment name: model-environment-timestamp
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            DEPLOYMENT_NAME="${{ inputs.model_name }}-${{ inputs.environment }}-${TIMESTAMP}"
          fi
          echo "deployment_name=${DEPLOYMENT_NAME}" >> $GITHUB_OUTPUT
          echo "Generated deployment name: ${DEPLOYMENT_NAME}"
      
      - name: Get AI Services name
        id: ai_services
        shell: bash
        run: |
          # Get the AI Services account name from the existing deployment
          AI_SERVICES_NAME=$(az cognitiveservices account list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?kind=='AIServices'].name | [0]" \
            -o tsv)
          
          if [ -z "$AI_SERVICES_NAME" ]; then
            echo "Error: No AI Services account found in resource group"
            exit 1
          fi
          
          echo "ai_services_name=${AI_SERVICES_NAME}" >> $GITHUB_OUTPUT
          echo "Found AI Services account: ${AI_SERVICES_NAME}"
      
      - name: Deploy Model
        id: deploy_model
        shell: bash
        run: |
          echo "Deploying ${{ inputs.model_name }} (version ${{ inputs.model_version }})..."
          
          # Deploy using BICEP template
          DEPLOYMENT_OUTPUT=$(az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infrastructure/model-deployment.bicep \
            --parameters \
              aiServicesName="${{ steps.ai_services.outputs.ai_services_name }}" \
              deploymentName="${{ steps.deployment_name.outputs.deployment_name }}" \
              modelName="${{ inputs.model_name }}" \
              modelVersion="${{ inputs.model_version }}" \
              skuName="${{ inputs.sku_name }}" \
              capacity=${{ inputs.capacity }} \
            --query 'properties.outputs' \
            -o json)
          
          echo "Deployment completed!"
          echo "$DEPLOYMENT_OUTPUT" | jq '.'
          
          # Extract outputs
          ENDPOINT=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.endpoint.value')
          DEPLOYMENT_ID=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.deploymentId.value')
          
          echo "endpoint=${ENDPOINT}" >> $GITHUB_OUTPUT
          echo "deployment_id=${DEPLOYMENT_ID}" >> $GITHUB_OUTPUT
      
      - name: Verify Model Deployment
        shell: bash
        run: |
          echo "Verifying model deployment..."
          
          DEPLOYMENT_STATUS=$(az cognitiveservices account deployment show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ steps.ai_services.outputs.ai_services_name }} \
            --deployment-name ${{ steps.deployment_name.outputs.deployment_name }} \
            --query '{Name:name, Model:properties.model.name, Version:properties.model.version, State:properties.provisioningState, Capacity:sku.capacity}' \
            -o table)
          
          echo "$DEPLOYMENT_STATUS"
      
      - name: Get AI Foundry Project Details
        id: project_details
        shell: bash
        run: |
          # Query for AI Foundry Hub to get the discovery URL
          echo "Searching for AI Foundry Hub and Project in resource group: ${{ env.RESOURCE_GROUP }}"
          
          # Get the AI Hub (kind=hub)
          HUB_DATA=$(az resource list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --resource-type "Microsoft.MachineLearningServices/workspaces" \
            --query "[?kind=='hub' || kind=='Hub'] | [0]" \
            -o json)
          
          if [ "$HUB_DATA" == "null" ] || [ -z "$HUB_DATA" ]; then
            echo "Error: No AI Foundry Hub found in resource group ${{ env.RESOURCE_GROUP }}"
            echo "Available workspaces:"
            az resource list --resource-group ${{ env.RESOURCE_GROUP }} --resource-type "Microsoft.MachineLearningServices/workspaces" --query "[].{Name:name, Kind:kind}" -o table
            exit 1
          fi
          
          HUB_NAME=$(echo "$HUB_DATA" | jq -r '.name')
          
          # Get full Hub details including discoveryUrl
          HUB_FULL=$(az resource show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --resource-type "Microsoft.MachineLearningServices/workspaces" \
            --name "${HUB_NAME}" \
            -o json)
          
          DISCOVERY_URL=$(echo "$HUB_FULL" | jq -r '.properties.discoveryUrl')
          
          # Extract workspace GUID from discovery URL
          # Format: https://12345678-1234-1234-1234-123456789012.workspace.eastus.api.azureml.ms/...
          WORKSPACE_GUID=$(echo "$DISCOVERY_URL" | sed -E 's|https://([^.]+)\..*|\1|')
          
          if [ -z "$WORKSPACE_GUID" ] || [ "$WORKSPACE_GUID" == "null" ]; then
            echo "Error: Could not extract workspace GUID from discovery URL: $DISCOVERY_URL"
            exit 1
          fi
          
          # Get the AI Foundry Project (kind=project)
          PROJECT_DATA=$(az resource list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --resource-type "Microsoft.MachineLearningServices/workspaces" \
            --query "[?kind=='project' || kind=='Project'] | [0]" \
            -o json)
          
          if [ "$PROJECT_DATA" == "null" ] || [ -z "$PROJECT_DATA" ]; then
            echo "Error: No AI Foundry Project found in resource group ${{ env.RESOURCE_GROUP }}"
            exit 1
          fi
          
          PROJECT_NAME=$(echo "$PROJECT_DATA" | jq -r '.name')
          
          # Construct the Agent Service endpoint
          # Format: https://{hub-name}.services.ai.azure.com/api/projects/{project-name}
          # The AIFoundryResourceName in the endpoint is the Hub name, not the workspace GUID
          PROJECT_ENDPOINT="https://${HUB_NAME}.services.ai.azure.com/api/projects/${PROJECT_NAME}"
          
          echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          echo "project_endpoint=${PROJECT_ENDPOINT}" >> $GITHUB_OUTPUT
          echo "hub_name=${HUB_NAME}" >> $GITHUB_OUTPUT
          echo "workspace_guid=${WORKSPACE_GUID}" >> $GITHUB_OUTPUT
          
          echo "✅ Found AI Foundry Hub: ${HUB_NAME}"
          echo "✅ Found AI Foundry Project: ${PROJECT_NAME}"
          echo "   Workspace GUID: ${WORKSPACE_GUID}"
          echo "   Discovery URL: ${DISCOVERY_URL}"
          echo "   Agent Service Endpoint: ${PROJECT_ENDPOINT}"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install azure-ai-projects azure-identity
      
      - name: Create AI Agent
        id: create_agent
        continue-on-error: true
        shell: bash
        env:
          PROJECT_ENDPOINT: ${{ steps.project_details.outputs.project_endpoint }}
          MODEL_DEPLOYMENT_NAME: ${{ steps.deployment_name.outputs.deployment_name }}
          AGENT_NAME: ${{ inputs.agent_name }}
          AGENT_INSTRUCTIONS: ${{ inputs.agent_instructions }}
        run: |
          echo "Creating agent with model deployment: ${MODEL_DEPLOYMENT_NAME}"
          python scripts/create_agent.py
      
      - name: Agent Creation Status
        shell: bash
        run: |
          if [ "${{ steps.create_agent.outcome }}" == "failure" ]; then
            echo "⚠️ Agent creation failed."
            echo ""
            echo "Common causes:"
            echo "1. Missing 'Azure AI Developer' role on the service principal"
            echo "2. Role assignment not yet propagated (can take 5-10 minutes)"
            echo "3. Invalid PROJECT_ENDPOINT format"
            echo ""
            echo "To fix:"
            echo "1. Go to Azure Portal → AI Services resource → Access control (IAM)"
            echo "2. Add role assignment: 'Azure AI Developer'"
            echo "3. Assign to: github-actions-aifoundry (service principal)"
            echo ""
            echo "For detailed instructions, see: docs/GITHUB_ACTIONS_SETUP.md"
            echo ""
            echo "✅ The model deployment was successful and can be used directly."
          else
            echo "✅ Agent created successfully!"
            echo "Agent ID: ${{ steps.create_agent.outputs.agentId }}"
            echo "Agent will be visible in Azure AI Foundry Studio: https://ai.azure.com"
          fi
      
      - name: Create Deployment Summary
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # 🤖 Model Deployment & Agent Creation Summary
          
          ## Deployment Details
          
          | Property | Value |
          |----------|-------|
          | **Environment** | ${{ inputs.environment }} |
          | **Model** | ${{ inputs.model_name }} |
          | **Version** | ${{ inputs.model_version }} |
          | **Deployment Name** | ${{ steps.deployment_name.outputs.deployment_name }} |
          | **SKU** | ${{ inputs.sku_name }} |
          | **Capacity** | ${{ inputs.capacity }} TPM (thousands) |
          | **AI Services** | ${{ steps.ai_services.outputs.ai_services_name }} |
          
          ## Agent Details
          
          EOF
          
          if [ "${{ steps.create_agent.outcome }}" == "success" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          | Property | Value |
          |----------|-------|
          | **Status** | ✅ Created Successfully |
          | **Agent Name** | ${{ inputs.agent_name }} |
          | **Agent ID** | ${{ steps.create_agent.outputs.agentId }} |
          | **Model Deployment** | ${{ steps.deployment_name.outputs.deployment_name }} |
          | **Project Endpoint** | ${{ steps.project_details.outputs.project_endpoint }} |
          | **Portal** | [View in Azure AI Foundry Studio](https://ai.azure.com) |
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          | Property | Value |
          |----------|-------|
          | **Status** | ⚠️ Creation Failed |
          | **Agent Name** | ${{ inputs.agent_name }} (not created) |
          
          > **Note**: Check the logs above for error details.
          > The model deployment is complete and can be used directly.
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## Next Steps
          
          1. **Test the agent** in Azure AI Foundry Studio: [https://ai.azure.com](https://ai.azure.com)
             - Navigate to your project
             - Click "My agents" in the left menu
             - Find your agent: ${{ inputs.agent_name }}
          2. **Use the agent** via Azure AI Projects SDK (see examples in docs)
          3. **Monitor usage** in the AI Services resource
          
          ## Useful Commands
          
          \`\`\`bash
          # List all deployments
          az cognitiveservices account deployment list \\
            --resource-group ${{ env.RESOURCE_GROUP }} \\
            --name ${{ steps.ai_services.outputs.ai_services_name }}
          
          # Delete this deployment
          az cognitiveservices account deployment delete \\
            --resource-group ${{ env.RESOURCE_GROUP }} \\
            --name ${{ steps.ai_services.outputs.ai_services_name }} \\
            --deployment-name ${{ steps.deployment_name.outputs.deployment_name }}
          \`\`\`
          EOF
    
    outputs:
      deployment_name: ${{ steps.deployment_name.outputs.deployment_name }}
      agent_id: ${{ steps.create_agent.outputs.agentId }}
      agent_name: ${{ steps.create_agent.outputs.agentName }}
      project_endpoint: ${{ steps.project_details.outputs.project_endpoint }}
      project_name: ${{ steps.project_details.outputs.project_name }}
