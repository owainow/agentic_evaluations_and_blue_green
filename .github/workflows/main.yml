name: "Deploy Model, Agent & Run Combined Evaluation"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
        default: 'dev'
      
      model_name:
        description: 'Model to deploy'
        required: true
        type: choice
        options:
          - gpt-4o
          - gpt-4o-mini
          - gpt-4
          - gpt-4-turbo
          - gpt-35-turbo
          - gpt-35-turbo-16k
        default: 'gpt-4o'
      
      model_version:
        description: 'Model version'
        required: true
        type: string
        default: '2024-11-20'
      
      deployment_name:
        description: 'Name for the model deployment (leave empty to auto-generate)'
        required: false
        type: string
      
      sku_name:
        description: 'Deployment SKU type'
        required: true
        type: choice
        options:
          - Standard
          - GlobalStandard
        default: 'Standard'
      
      capacity:
        description: 'Deployment capacity (tokens per minute in thousands)'
        required: true
        type: number
        default: 10
      
      agent_name:
        description: 'Name for the AI agent'
        required: true
        type: string
        default: 'Weather News Agent with Azure Functions & Search'
      
      run_blue_green:
        description: 'Run blue/green deployment with human approval after evaluation'
        required: false
        type: boolean
        default: false
permissions:
  id-token: write
  contents: read

jobs:
  deploy-model-and-agent:
    name: Deploy Model and Create Agent
    uses: ./.github/workflows/deploy-model-and-agent.yml
    with:
      environment: ${{ inputs.environment }}
      model_name: ${{ inputs.model_name }}
      model_version: ${{ inputs.model_version }}
      deployment_name: ${{ inputs.deployment_name }}
      sku_name: ${{ inputs.sku_name }}
      capacity: ${{ inputs.capacity }}
      agent_name: ${{ inputs.agent_name }}
      run_blue_green: ${{ inputs.run_blue_green }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  run-combined-evaluation:
    name: Run Combined Evaluation (Agent + GenAI)
    needs: deploy-model-and-agent
    if: ${{ needs.deploy-model-and-agent.outputs.agent_id != '' }}
    uses: ./.github/workflows/combined-evaluation.yml
    with:
      project_endpoint: ${{ needs.deploy-model-and-agent.outputs.project_endpoint }}
      deployment_name: ${{ needs.deploy-model-and-agent.outputs.deployment_name }}
      agent_id: ${{ needs.deploy-model-and-agent.outputs.agent_id }}
      function_app_url: ${{ needs.deploy-model-and-agent.outputs.function_app_url }}
      azure_endpoint: ${{ needs.deploy-model-and-agent.outputs.azure_openai_endpoint }}
      api_version: '2024-10-21'
      agent_data_file: 'weather_test.json'
      genai_data_file: 'genai_evaluation_test.json'
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_OPENAI_API_KEY: ${{ needs.deploy-model-and-agent.outputs.azure_openai_api_key }}

  blue-green-deployment:
    name: Blue/Green Deployment with Approval
    needs: [deploy-model-and-agent, run-combined-evaluation]
    if: ${{ inputs.run_blue_green == true && needs.run-combined-evaluation.result == 'success' }}
    uses: ./.github/workflows/blue-green-deployment-with-approval.yml
    with:
      environment: ${{ inputs.environment }}
      project_endpoint: ${{ needs.deploy-model-and-agent.outputs.project_endpoint }}
      deployment_name: ${{ needs.deploy-model-and-agent.outputs.deployment_name }}
      agent_id: ${{ needs.deploy-model-and-agent.outputs.agent_id }}
      evaluation_results: "Combined evaluation completed on ${{ github.run_id }}. Agent: ${{ needs.deploy-model-and-agent.outputs.agent_id }}. Model: ${{ needs.deploy-model-and-agent.outputs.deployment_name }}. Check job artifacts for detailed results."
      evaluation_passed: ${{ needs.run-combined-evaluation.result == 'success' }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
